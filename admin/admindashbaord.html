<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background: #333;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
        }
        .container {
            padding: 20px;
        }
        .btn {
            display: inline-block;
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
        }
        table th, table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        table th {
            background-color: #007BFF;
            color: #fff;
        }
    </style>
</head>
<body>

<header>
    <h1>Admin Dashboard</h1>
</header>

<div class="container">
    <h2>User Management</h2>
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Admin</th>
                <th>Last Login</th>
                <th>Created At</th>
            </tr>
        </thead>
        <tbody id="user-list">
            <!-- Users will be dynamically loaded here -->
        </tbody>
    </table>
</div>

<script>
    const apiUrl = window.location.origin;

    async function fetchUsers() {
    try {
        // Retrieve token from localStorage or another secure source
        const token = localStorage.getItem("token"); // Replace with your actual token storage mechanism

        if (!token) {
            throw new Error('No authentication token found. Please log in.');
        }

        // Make the API request
        const response = await fetch(`${apiUrl}/get-users`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`, // Use the retrieved token
            },
        });

        // Handle non-OK responses
        if (!response.ok) {
            if (response.status === 401) {
                console.error('Unauthorized access. Please check your token or log in again.');
                alert('Session expired or unauthorized. Redirecting to login.');
                window.location.href = '/login.html'; // Redirect to login page
            } else if (response.status === 403) {
                alert('Access denied. Admin privileges required.');
            }
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
        }

        // Parse and handle the response
        const users = await response.json();
        console.log('Fetched users:', users);

        // Render the users list or handle it as needed
        renderUserList(users);
    } catch (error) {
        console.error('Error fetching users:', error);
        alert('Failed to fetch user data. Please try again later.');
    }
}


    function renderUserList(users) {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.isAdmin ? 'Yes' : 'No'}</td>
                <td>${new Date(user.lastLogin).toLocaleString()}</td>
                <td>${new Date(user.createdAt).toLocaleString()}</td>
            `;
            userList.appendChild(row);
        });
    }
    function renderUserList(users) {
    const userList = document.getElementById('user-list');
    userList.innerHTML = '';

    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.isAdmin ? 'Yes' : 'No'}</td>
            <td>${new Date(user.lastLogin).toLocaleString()}</td>
            <td>${new Date(user.createdAt).toLocaleString()}</td>
            <td>
                <button class="btn" onclick="loginAsUser('${user._id}')">Login as User</button>
            </td>
        `;
        userList.appendChild(row);
    });
}
async function loginAsUser(userId) {
    try {
        const adminToken = localStorage.getItem('authToken');

        if (!adminToken) {
            alert('Admin token not found. Please log in as admin.');
            return;
        }

        const response = await fetch(`${apiUrl}/generate-user-token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`, // Admin token
            },
            body: JSON.stringify({ userId }),
        });

        if (!response.ok) {
            if (response.status === 403) {
                alert('Permission denied. Unable to log in as this user.');
            }
            throw new Error('Failed to generate user token');
        }

        const data = await response.json();

        // Clear existing session storage or local storage if needed
        localStorage.removeItem('authToken'); // Remove the admin token or previous user token
        localStorage.setItem('authToken', data.token); // Store the new user token

        alert('Logged in as user. Redirecting...');
        window.location.href = '/dashboard.html'; // Redirect to user's dashboard
    } catch (error) {
        console.error('Error logging in as user:', error);
        alert('Failed to log in as user.');
    }
}


    // Initialize the dashboard
    fetchUsers();
</script>

</body>
</html>
